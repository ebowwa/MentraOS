/**
 * @file mentraos_audio.overlay
 * @brief MentraOS Audio System Device Tree Overlay
 * 
 * Configures nRF5340 for complete audio pipeline:
 * - PDM microphone input (P1.11/P1.12)
 * - I2S audio output for MAX98357A (P1.06/P1.07/P1.08)
 * 
 * Based on actual MentraOS configuration from:
 * /Users/loayyari/Documents/Github/MentraOS_TESTS/mcu_client/nrf5340/mentraos_nrf5340/app.overlay
 * 
 * Hardware Setup:
 * MAX98357A I2S Audio Amplifier:
 *   - P1.06 → LRC (Left/Right Clock)
 *   - P1.07 → BCLK (Bit Clock)  
 *   - P1.08 → DIN (Audio Data Input)
 *   - VDD → 3.3V
 *   - GND → Ground
 * 
 * PDM Microphone:
 *   - P1.12 → CLK (PDM Clock)
 *   - P1.11 → DAT (PDM Data)
 *   - VDD → 3.3V
 *   - GND → Ground
 */

/ {
	chosen {
		// Use UART for logging output
		zephyr,console = &uart0;
		zephyr,shell-uart = &uart0;
	};
	
	aliases {
		// Define audio device aliases
		audio-i2s = &i2s0;
		audio-pdm = &pdm0;
	};
};

// Add audio clock support
&clock {
	hfclkaudio-frequency = <12288000>;
};

&pinctrl {
	// I2S pin configuration (matching MentraOS)
	i2s0_default: i2s0_default {
		group1 {
			psels = <NRF_PSEL(I2S_SDOUT, 1, 6)>,    // P1.06 - Serial Data Output to MAX98357A DIN
			        <NRF_PSEL(I2S_SCK_M, 1, 7)>,    // P1.07 - Serial Clock Master to MAX98357A BCLK
			        <NRF_PSEL(I2S_LRCK_M, 1, 8)>;   // P1.08 - LR Clock Master to MAX98357A LRC
		};
	};

	i2s0_sleep: i2s0_sleep {
		group1 {
			psels = <NRF_PSEL(I2S_SDOUT, 1, 6)>,
			        <NRF_PSEL(I2S_SCK_M, 1, 7)>,
			        <NRF_PSEL(I2S_LRCK_M, 1, 8)>;
			low-power-enable;
		};
	};

	// PDM pin configuration (matching MentraOS)
	pdm0_default_alt: pdm0_default_alt {
		group1 {
			psels = <NRF_PSEL(PDM_CLK, 1, 12)>,    // P1.12 - PDM Clock
			        <NRF_PSEL(PDM_DIN, 1, 11)>;    // P1.11 - PDM Data Input
		};
	};

	pdm0_sleep: pdm0_sleep {
		group1 {
			psels = <NRF_PSEL(PDM_CLK, 1, 12)>,
			        <NRF_PSEL(PDM_DIN, 1, 11)>;
			low-power-enable;
		};
	};
};

// I2S Audio Output Configuration (for MAX98357A)
&i2s0 {
	compatible = "nordic,nrf-i2s";
	status = "okay";
	pinctrl-0 = <&i2s0_default>;
	pinctrl-1 = <&i2s0_sleep>;
	pinctrl-names = "default", "sleep";
	
	// Audio clock configuration (matching MentraOS)
	clock-source = "ACLK";  // Use Audio Clock for precision timing
};

// PDM Microphone Configuration
&pdm0 {
	compatible = "nordic,nrf-pdm";
	status = "okay";
	pinctrl-0 = <&pdm0_default_alt>;
	pinctrl-1 = <&pdm0_sleep>;
	pinctrl-names = "default", "sleep";
	
	// PDM clock configuration - using ACLK for precision
	clock-source = "ACLK";
};

// UART Configuration for logging
&uart0 {
	status = "okay";
	current-speed = <115200>;
	pinctrl-0 = <&uart0_default>;
	pinctrl-1 = <&uart0_sleep>;
	pinctrl-names = "default", "sleep";
};

// GPIO Configuration (for status LED)
&gpio0 {
	status = "okay";
	sense-edge-mask = <0xffffffff>;
};

&gpio1 {
	status = "okay";
	sense-edge-mask = <0xffffffff>;
};

// Disable unused peripherals to save power
&uart1 {
	status = "disabled";
};

&spi0 {
	status = "disabled";
};

&spi1 {
	status = "disabled";
};

&spi2 {
	status = "disabled";
};

&i2c0 {
	status = "disabled";
};

&i2c1 {
	status = "disabled";
};

&pwm0 {
	status = "disabled";
};

&pwm1 {
	status = "disabled";
};

&pwm2 {
	status = "disabled";
};

// Disable NFC to free up pins
&nfct {
	status = "disabled";
};

// Keep USB CDC for development
&zephyr_udc0 {
	status = "okay";
};
